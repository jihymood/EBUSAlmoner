package com.xpro.ebusalmoner.activity;

import android.annotation.SuppressLint;
import android.app.AlertDialog;
import android.app.DatePickerDialog.OnDateSetListener;
import android.content.Context;
import android.content.Intent;
import android.os.Bundle;
import android.os.Message;
import android.util.Log;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.AdapterView;
import android.widget.AdapterView.OnItemClickListener;
import android.widget.ArrayAdapter;
import android.widget.Button;
import android.widget.CompoundButton;
import android.widget.CompoundButton.OnCheckedChangeListener;
import android.widget.DatePicker;
import android.widget.ImageView;
import android.widget.ListView;
import android.widget.RadioButton;
import android.widget.TextView;

import com.alibaba.fastjson.JSON;
import com.xpro.ebusalmoner.R;
import com.xpro.ebusalmoner.adapter.HistoryAdapter;
import com.xpro.ebusalmoner.baseapi.BaseActivity;
import com.xpro.ebusalmoner.baseapi.BaseHandler;
import com.xpro.ebusalmoner.constants.Constants;
import com.xpro.ebusalmoner.entity.CharacterParser;
import com.xpro.ebusalmoner.entity.PinyinComparator;
import com.xpro.ebusalmoner.entity.SortModel;
import com.xpro.ebusalmoner.logic.TaskLogic;
import com.xpro.ebusalmoner.test.HistoryBody_M;
import com.xpro.ebusalmoner.test.HistoryData_M;
import com.xpro.ebusalmoner.test.HistoryRoot_M;
import com.xpro.ebusalmoner.utils.ToastUtils;
import com.xpro.ebusalmoner.widget.CommonDatePickerDialog;

import org.xutils.common.Callback.CommonCallback;
import org.xutils.http.RequestParams;
import org.xutils.view.annotation.ContentView;
import org.xutils.x;

import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.List;

/**
 * 救济-->历史详情页
 *
 * @author huangjh
 */

@ContentView(R.layout.fragment_history)
public class HistoryActivity extends BaseActivity implements OnClickListener,
        OnCheckedChangeListener {

    private View view;
    private ListView listView;
    private ArrayAdapter<SortModel> adapter;
    private HistoryAdapter adapter1;
    private List<HistoryData_M> data;
    private List<HistoryData_M> data0;// 已完成
    private List<HistoryData_M> data1;// 待完成
    private List<HistoryData_M> data2;// 待完成
    private CharacterParser characterParser;// 汉字转换成拼音的类
    private PinyinComparator pinyinComparator;
    private TextView nameText, dateText;
    private RadioButton finishRadio, jcRadio, cancelRadio;
    private Calendar calendar;
    private SimpleDateFormat date, sdf;
    private Button set;
    private ImageView back;
    private String dateStr;
    private MyHandler handler;
    private TaskLogic logic;

    private String json = "{\"success\": \"true\", "
            + "\"body\": {\"data\":[{\"id\": \"100\", "
            + "\"plateNumber\": \"1号拖车\",\"hitchLatitude\": "
            + "\"31.9813440513\", \"hitchLongitude\": \"118.7626883184\", "
            + "\"driverName\": \"科比代笔\", \"driverTel\": \"18769029715\", "
            + "\"line\": \"108路\",\"state\":0,\"images_driver\":[{\"url\": \"http://img5.duitang.com/uploads/item/201406/17/20140617140412_JKnZU.thumb.700_0.jpeg\"},"
            + "{\"url\": \"http://img5.duitang.com/uploads/item/201406/17/20140617140412_JKnZU.thumb.700_0.jpeg\"}],"
            + "\"cause\":\"轮胎爆破\",\"images_trailer\":[{\"url\": \"http://img5.duitang.com/uploads/item/201406/17/20140617140412_JKnZU.thumb.700_0.jpeg\"},"
            + "{\"url\": \"http://img5.duitang.com/uploads/item/201406/17/20140617140412_JKnZU.thumb.700_0.jpeg\"}],"
            + "\"hitchTime\": \"2013.02.12\",\"number\": \"JN-0039\"},{\"id\": \"100\", "
            + "\"plateNumber\": \"1号拖车\",\"hitchLatitude\": "
            + "\"31.9813440513\", \"hitchLongitude\": \"118.7626883184\", "
            + "\"driverName\": \"科比呆逼\", \"driverTel\": \"18769029715\", "
            + "\"line\": \"118路\",\"state\":1,\"images_driver\":[{\"url\": \"http://img5.duitang.com/uploads/item/201406/17/20140617140412_JKnZU.thumb.700_0.jpeg\"},"
            + "{\"url\": \"http://img5.duitang.com/uploads/item/201406/17/20140617140412_JKnZU.thumb.700_0.jpeg\"}],"
            + "\"cause\":\"轮胎爆破\",\"images_trailer\":[{\"url\": \"http://img5.duitang.com/uploads/item/201406/17/20140617140412_JKnZU.thumb.700_0.jpeg\"},"
            + "{\"url\": \"http://img5.duitang.com/uploads/item/201406/17/20140617140412_JKnZU.thumb.700_0.jpeg\"}],"
            + "\"hitchTime\": \"2014.02.12\",\"number\": \"JN-0039\"},{\"id\": \"100\", "
            + "\"plateNumber\": \"1号拖车\",\"hitchLatitude\": "
            + "\"31.9813440513\", \"hitchLongitude\": \"118.7626883184\", "
            + "\"driverName\": \"科比代币\", \"driverTel\": \"18769029715\", "
            + "\"line\": \"128路\",\"state\":2,\"images_driver\":[{\"url\": \"http://img5.duitang.com/uploads/item/201406/17/20140617140412_JKnZU.thumb.700_0.jpeg\"},"
            + "{\"url\": \"http://img5.duitang.com/uploads/item/201406/17/20140617140412_JKnZU.thumb.700_0.jpeg\"}],"
            + "\"cause\":\"轮胎爆破\",\"images_trailer\":[{\"url\": \"http://img5.duitang.com/uploads/item/201406/17/20140617140412_JKnZU.thumb.700_0.jpeg\"},"
            + "{\"url\": \"http://img5.duitang.com/uploads/item/201406/17/20140617140412_JKnZU.thumb.700_0.jpeg\"}],"
            + "\"hitchTime\": \"2015.02.12\",\"number\": \"JN-0039\"}]}, \"errorCode\": \"-1\",\"msg\": \"成功\"}";

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        // TODO Auto-generated method stub
        super.onCreate(savedInstanceState);

//		Log.e("HistoryActivity", json);

        initView();
//        getData();
//		getServerData(dateStr);

        handler = new MyHandler(HistoryActivity.this);
        logic = new TaskLogic(handler, HistoryActivity.this);
        logic.hasCompleteTask(dateStr);

        adapter1 = new com.xpro.ebusalmoner.adapter.HistoryAdapter(data, this);//一进来默认填充state=0的数据，可以是data/data0
        listView.setAdapter(adapter1);

        onListener();
    }

    public void initView() {
        nameText = (TextView) findViewById(R.id.name);
        set = (Button) findViewById(R.id.set);
        back = (ImageView) findViewById(R.id.back);
        listView = (ListView) findViewById(R.id.listView);
        finishRadio = (RadioButton) findViewById(R.id.finishRadio);
        jcRadio = (RadioButton) findViewById(R.id.jcRadio);
        cancelRadio = (RadioButton) findViewById(R.id.cancelRadio);
        dateText = (TextView) findViewById(R.id.dateText);
        // if(ismanager){
        // nameText.setText("历史故障");
        // }else{
        // nameText.setText("历史任务");
        // }

        data = new ArrayList<HistoryData_M>();
        data0 = new ArrayList<HistoryData_M>();
        data1 = new ArrayList<HistoryData_M>();
        data2 = new ArrayList<HistoryData_M>();

        finishRadio.setOnCheckedChangeListener(this);
        jcRadio.setOnCheckedChangeListener(this);
        cancelRadio.setOnCheckedChangeListener(this);
        set.setOnClickListener(this);
        back.setOnClickListener(this);

        getTodayDate();
    }

    public void getTodayDate() {
        sdf = new SimpleDateFormat("yyyy-MM-dd");
        Date date = new Date();
        dateStr = sdf.format(date);
        Log.e("HistoryActivity", "date:" + dateStr);
        dateText.setText(dateStr);
    }

    /**
     * 历史信息接口
     */
    public void getServerData(String date) {
        data = new ArrayList<HistoryData_M>();
        data0 = new ArrayList<HistoryData_M>();
        data1 = new ArrayList<HistoryData_M>();
        data2 = new ArrayList<HistoryData_M>();

        String url = "http://192.168.8.108:8080/EBUS/app?";
        RequestParams params = new RequestParams(url);
        params.addBodyParameter("messageType", "historyFault");
        params.addBodyParameter("id", "0");
        params.addBodyParameter("date", date);
        x.http().get(params, new CommonCallback<String>() {

            @Override
            public void onSuccess(String result) {
                Log.e("HistoryActivity", "result" + result);
                HistoryRoot_M root = JSON.parseObject(result, HistoryRoot_M.class);
                HistoryBody_M body = root.getBody();
                List<HistoryData_M> dataList = body.getData();
                if (dataList != null && dataList.size() > 0) {
                    for (int i = 0; i < dataList.size(); i++) {
                        HistoryData_M subData = dataList.get(i);
                        int state = subData.getState();
                        if ("0".equals(state + "")) { // 已修好
                            data0.add(subData);
                            data.addAll(data0);
                            adapter1 = new HistoryAdapter(data, HistoryActivity.this);
                            listView.setAdapter(adapter1);
                        } else if ("1".equals(state + "")) { // 进场维修
                            data1.add(subData);
//							adapter1.notifyDataSetChanged();
                        } else { // 已取消
                            data2.add(subData);
//							adapter1.notifyDataSetChanged();
                        }
                    }
                }
            }

            @Override
            public void onCancelled(CancelledException arg0) {
                // TODO Auto-generated method stub
                Log.e("onCancelled", "onCancelled");
            }

            @Override
            public void onError(Throwable arg0, boolean arg1) {
                // TODO Auto-generated method stub
                Log.e("onError", "onError");
            }

            @Override
            public void onFinished() {
                // TODO Auto-generated method stub
                Log.e("onFinished", "onFinished");
            }

        });

    }

    public void getData() {
        data = new ArrayList<HistoryData_M>();
        data0 = new ArrayList<HistoryData_M>();
        data1 = new ArrayList<HistoryData_M>();
        data2 = new ArrayList<HistoryData_M>();

        HistoryRoot_M root = JSON.parseObject(json, HistoryRoot_M.class);
        HistoryBody_M body = root.getBody();
        List<HistoryData_M> dataList = body.getData();
        if (dataList != null && dataList.size() > 0) {
            for (int i = 0; i < dataList.size(); i++) {
                HistoryData_M subData = dataList.get(i);

                int state = subData.getState();
                if ("0".equals(state + "")) { // 已修好
                    data0.add(subData);
                    data.addAll(data0);
                    adapter1 = new HistoryAdapter(data, this);
                    listView.setAdapter(adapter1);
                } else if ("1".equals(state + "")) { // 进场维修
                    data1.add(subData);
                } else { // 已取消
                    data2.add(subData);
                }
            }
        }
    }


    public void onListener() {
        listView.setOnItemClickListener(new OnItemClickListener() {
            @Override
            public void onItemClick(AdapterView<?> parent, View view,
                                    int position, long id) {
                // TODO Auto-generated method stub
                HistoryData_M subData = data.get(position);
                Bundle bundle = new Bundle();
                Intent intent = new Intent(HistoryActivity.this,
                        HistoryInfoActivity.class);
                bundle.putParcelable("HistoryData_M", subData);
                intent.putExtras(bundle);
                startActivity(intent);
            }
        });
    }

    // 日期选择
    @SuppressLint("SimpleDateFormat")
    public void dateSelectBtn() {
        calendar = Calendar.getInstance();
        date = new SimpleDateFormat("yyyy年MM月dd日");// 月份选择
        CommonDatePickerDialog dialog = new CommonDatePickerDialog(this,
                AlertDialog.THEME_HOLO_LIGHT, new OnDateSetListener() {
            @Override
            public void onDateSet(DatePicker view, int year, int month,
                                  int day) {
                if (year == calendar.get(Calendar.YEAR)
                        && month == calendar.get(Calendar.MONTH)
                        && day == calendar.get(Calendar.DAY_OF_MONTH)) {
                    calendar.set(year, month, day);
                } else {
                    calendar.set(year, month, day); // 默认当月1号
                }
                // 确定按钮后查询接口，得到某一天的json串
                dateText.setText(date.format(calendar.getTime()));
                String date = sdf.format(calendar.getTime());
                //查询某一天的数据
                data.clear();
                data0.clear();
                data1.clear();
                data2.clear();
                logic.hasCompleteTask(date);
//                getData();

            }
        }, calendar.get(Calendar.YEAR), calendar.get(Calendar.MONTH),
                calendar.get(Calendar.DAY_OF_MONTH));
        dialog.show();
    }


    @Override
    public void onClick(View v) {
        // TODO Auto-generated method stub
        switch (v.getId()) {
            case R.id.set:
                dateSelectBtn();
                break;
            case R.id.back:
                finish();
                break;

            default:
                break;
        }
    }

    @Override
    public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {
        // TODO Auto-generated method stub
        if (isChecked) {
            switch (buttonView.getId()) {
                case R.id.finishRadio: //切换到"已完成",清空data数据，将data0重新填充
                    data.clear();
                    data.addAll(data0);
                    adapter1.notifyDataSetChanged();
                    break;
                case R.id.jcRadio:
                    data.clear();
                    data.addAll(data1);
                    adapter1.notifyDataSetChanged();
                    break;
                case R.id.cancelRadio:
                    data.clear();
                    data.addAll(data2);
                    adapter1.notifyDataSetChanged();
                    break;

                default:
                    break;
            }

        }
    }

    class MyHandler extends BaseHandler {

        public MyHandler(Context context) {
            super(context);
            // TODO Auto-generated constructor stub
        }

        @Override
        public void doHandle(Message msg) {
            // TODO Auto-generated method stub
            super.doHandle(msg);
            switch (msg.what) {
                case Constants.manager_complete_success:
                    List<HistoryData_M> dataList = (List<HistoryData_M>) msg.obj;
                    if (dataList != null && dataList.size() > 0) {
                        for (int i = 0; i < dataList.size(); i++) {
                            HistoryData_M subData = dataList.get(i);
                            int state = subData.getState();
                            if ("0".equals(state + "")) { // 已修好
                                data0.add(subData);
                                data.addAll(data0);
                                adapter1 = new HistoryAdapter(data, HistoryActivity.this);
                                listView.setAdapter(adapter1);
                            } else if ("1".equals(state + "")) { // 进场维修
                                data1.add(subData);
//                                adapter1.notifyDataSetChanged();
                            } else { // 已取消
                                data2.add(subData);
//                                adapter1.notifyDataSetChanged();
                            }
                        }
                    } else {

                    }

                    break;

                case Constants.manager_complete_fail:
                    ToastUtils.showToast(HistoryActivity.this, "" + msg.obj);
                    break;
                default:
                    break;
            }
        }


    }

}
